name: Playwright Tests

on:
  # Trigger on push to feature branches and main
  push:
    branches: 
      - 'main'
      - 'feature/**'
      - 'bugfix/**'
      - 'fix/**'
  
  # Full tests on PR
  pull_request:
    branches: [ main ]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      test_grep:
        description: 'Run specific tests (e.g., @smoke, @login, @cart)'
        required: false
        type: string

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Smoke tests for feature branches (fast feedback)
  smoke-tests:
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright Browsers (Chromium only)
        run: npx playwright install --with-deps chromium
      
      - name: Run Smoke Tests
        run: npx playwright test --grep @smoke --project=chromium
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results-${{ github.sha }}
          path: playwright-report/
          retention-days: 7

  # Job 2: Full tests for Pull Requests (quality gate - Chromium only)
  pr-tests:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright Browsers (Chromium only)
        run: npx playwright install --with-deps chromium
      
      - name: Run Full Test Suite (Chromium only)
        run: npx playwright test --project=chromium
      
      - name: Generate Allure Report
        if: always()
        env:
          ALLURE_RESULTS_LIMIT: 10
        run: |
          npm install -g allure-commandline
          allure generate allure-results --clean -o allure-report
      
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-pr-${{ github.event.pull_request.number }}
          path: playwright-report/
          retention-days: 14
      
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-pr-${{ github.event.pull_request.number }}
          path: allure-report/
          retention-days: 14
      
      - name: Comment PR with test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const testResults = '${{ job.status }}';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const body = `## üé≠ Playwright Test Results\n\n` +
              `**Status:** ${testResults === 'success' ? '‚úÖ All tests passed' : '‚ùå Tests failed'}\n` +
              `**Browser:** Chromium only\n` +
              `**Note:** Full cross-browser testing will run after merge to main\n\n` +
              `üìä [View Test Reports](${runUrl})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # Job 3: Full tests on all browsers + deploy for main branch (official results with trends)
  main-tests-and-deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    concurrency:
      group: "pages"
      cancel-in-progress: false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright Browsers (All browsers)
        run: npx playwright install --with-deps
      
      - name: Run Full Test Suite (All browsers)
        run: npx playwright test --grep @smoke
      
      - name: Download previous Allure history (for trends)
        if: always()
        continue-on-error: true
        run: |
          mkdir -p allure-results/history
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          PAGES_URL="https://${{ github.repository_owner }}.github.io/${REPO_NAME}"
          echo "Fetching history from: $PAGES_URL/history/"
          
          for f in history.json history-trend.json duration-trend.json categories-trend.json retry-trend.json; do
            curl -f -s -L "${PAGES_URL}/history/$f" -o "allure-results/history/$f" || echo "Missing $f - ok for first run"
          done
          
          echo "History files downloaded:"
          ls -la allure-results/history/ || true
      
      - name: Generate Allure Report
        if: always()
        env:
          ALLURE_RESULTS_LIMIT: 10
        run: |
          npm install -g allure-commandline
          allure generate allure-results --clean -o allure-report
          echo "Allure report generated with history"
      
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-main
          path: playwright-report/
          retention-days: 30
      
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-main
          path: allure-report/
          retention-days: 30
      
      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-main
          path: allure-results/
          retention-days: 30
      
      - name: Setup Pages
        if: always()
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-report
      
      - name: Deploy to GitHub Pages
        if: always()
        id: deployment
        uses: actions/deploy-pages@v4

  # Job 4: Manual test execution with custom filters
  manual-tests:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      
      - name: Run Tests with Filter
        run: |
          if [ -n "${{ github.event.inputs.test_grep }}" ]; then
            echo "Running tests with grep: ${{ github.event.inputs.test_grep }}"
            npx playwright test --grep "${{ github.event.inputs.test_grep }}"
          else
            npx playwright test
          fi
      
      - name: Generate Allure Report
        if: always()
        env:
          ALLURE_RESULTS_LIMIT: 10
        run: |
          npm install -g allure-commandline
          allure generate allure-results --clean -o allure-report
      
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-manual-${{ github.run_id }}
          path: playwright-report/
          retention-days: 14
      
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-manual-${{ github.run_id }}
          path: allure-report/
          retention-days: 14
