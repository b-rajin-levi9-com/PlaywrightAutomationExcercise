name: Playwright Tests

on:
  push:
    branches: 
      - 'main'
      - 'feature/**'
      - 'bugfix/**'
      - 'fix/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_grep:
        description: 'Run specific tests (e.g., @smoke, @login, @cart)'
        required: false
        type: string

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      # ============================================
      # COMMON STEPS with CACHING
      # ============================================
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node with npm cache
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      # Determine which browsers to install
      - name: Set browser installation type
        id: browser-type
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "type=all-browsers" >> $GITHUB_OUTPUT
          else
            echo "type=chromium-only" >> $GITHUB_OUTPUT
          fi
      
      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(npm list @playwright/test --depth=0 --json | jq -r '.dependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT
      
      # Cache Playwright browsers with browser-type in key
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}-${{ steps.browser-type.outputs.type }}
          restore-keys: |
            playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}-
      
      # ============================================
      # CONDITIONAL: Install browsers (only if not cached)
      # ============================================
      # Install only Chromium for feature branches and PRs
      - name: Install Playwright Browsers (Chromium only)
        if: |
          steps.playwright-cache.outputs.cache-hit != 'true' &&
          steps.browser-type.outputs.type == 'chromium-only'
        run: npx playwright install --with-deps chromium
      
      # Install all browsers for main branch and manual runs
      - name: Install Playwright Browsers (All browsers)
        if: |
          steps.playwright-cache.outputs.cache-hit != 'true' &&
          steps.browser-type.outputs.type == 'all-browsers'
        run: npx playwright install --with-deps
      
      # Install system dependencies if browsers were cached
      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps
      
      # ============================================
      # CONDITIONAL: Run tests
      # ============================================
      # Feature branches: Smoke tests only on Chromium
      - name: Run Smoke Tests (Feature branches)
        if: github.event_name == 'push' && github.ref != 'refs/heads/main'
        run: npx playwright test --grep @smoke --project=chromium
      
      # PRs: Full tests on Chromium only
      - name: Run Full Test Suite (PRs - Chromium only)
        if: github.event_name == 'pull_request'
        run: npx playwright test --project=chromium
      
      # Main branch: Full tests on all browsers
      - name: Run Full Test Suite (Main - All browsers)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: npx playwright test
      
      # Manual: Custom tests with grep
      - name: Run Tests (Manual - Custom)
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ -n "${{ github.event.inputs.test_grep }}" ]; then
            echo "Running tests with grep: ${{ github.event.inputs.test_grep }}"
            npx playwright test --grep "${{ github.event.inputs.test_grep }}"
          else
            npx playwright test
          fi
      
      # ============================================
      # CONDITIONAL: Download history (only for main)
      # ============================================
      - name: Download previous Allure history
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          mkdir -p allure-results/history
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          PAGES_URL="https://${{ github.repository_owner }}.github.io/${REPO_NAME}"
          echo "Fetching history from: $PAGES_URL/history/"
          
          for f in history.json history-trend.json duration-trend.json categories-trend.json retry-trend.json; do
            curl -f -s -L "${PAGES_URL}/history/$f" -o "allure-results/history/$f" || echo "Missing $f"
          done
          
          echo "History files downloaded:"
          ls -la allure-results/history/ || true
      
      # ============================================
      # COMMON: Generate Allure Report (always)
      # ============================================
      - name: Generate Allure Report
        if: always()
        env:
          ALLURE_RESULTS_LIMIT: 10
        run: |
          npm install -g allure-commandline
          allure generate allure-results --clean -o allure-report
          echo "Allure report generated"
      
      # ============================================
      # CONDITIONAL: Upload artifacts with proper retention
      # ============================================
      # Upload Playwright report - Main branch (30 days)
      - name: Upload Playwright Report (Main)
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-main-${{ github.run_id }}
          path: playwright-report/
          retention-days: 30
      
      # Upload Playwright report - PR (14 days)
      - name: Upload Playwright Report (PR)
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-pr-${{ github.event.pull_request.number }}
          path: playwright-report/
          retention-days: 14
      
      # Upload Playwright report - Feature branches (7 days)
      - name: Upload Playwright Report (Feature)
        if: always() && github.event_name == 'push' && github.ref != 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-feature-${{ github.run_id }}
          path: playwright-report/
          retention-days: 7
      
      # Upload Playwright report - Manual (14 days)
      - name: Upload Playwright Report (Manual)
        if: always() && github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-manual-${{ github.run_id }}
          path: playwright-report/
          retention-days: 14
      
      # Upload Allure report - Main branch (30 days)
      - name: Upload Allure Report (Main)
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-main-${{ github.run_id }}
          path: allure-report/
          retention-days: 30
      
      # Upload Allure report - PR (14 days)
      - name: Upload Allure Report (PR)
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-pr-${{ github.event.pull_request.number }}
          path: allure-report/
          retention-days: 14
      
      # Upload Allure report - Feature branches (7 days)
      - name: Upload Allure Report (Feature)
        if: always() && github.event_name == 'push' && github.ref != 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-feature-${{ github.run_id }}
          path: allure-report/
          retention-days: 7
      
      # Upload Allure report - Manual (14 days)
      - name: Upload Allure Report (Manual)
        if: always() && github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-manual-${{ github.run_id }}
          path: allure-report/
          retention-days: 14
      
      # Upload Allure results (only main)
      - name: Upload Allure Results
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-main-${{ github.run_id }}
          path: allure-results/
          retention-days: 30
      
      # ============================================
      # CONDITIONAL: PR Comment
      # ============================================
      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const testResults = '${{ job.status }}';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const body = `## üé≠ Playwright Test Results\n\n` +
              `**Status:** ${testResults === 'success' ? '‚úÖ All tests passed' : '‚ùå Tests failed'}\n` +
              `**Browser:** Chromium only\n` +
              `**Note:** Full cross-browser testing will run after merge to main\n\n` +
              `üìä [View Test Reports](${runUrl})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      # ============================================
      # CONDITIONAL: Deploy to GitHub Pages (only main)
      # ============================================
      - name: Setup Pages
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-report
      
      - name: Deploy to GitHub Pages
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: deployment
        uses: actions/deploy-pages@v4